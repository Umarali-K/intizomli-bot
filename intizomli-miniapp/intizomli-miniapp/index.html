<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intizomli Erkak ‚Äî Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #081426;
      --card: #10233f;
      --line: rgba(255, 255, 255, 0.12);
      --txt: #edf3ff;
      --muted: #9db0cf;
      --ok: #1fc77e;
      --warn: #f2ad22;
      --danger: #ff6b6b;
      --brand: #2a63ff;
      --habits: #2f6bff;
      --sports: #22b573;
      --reading: #f2ad22;
      --challenge: #9b59b6;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(circle at top, #132749, var(--bg)); color: var(--txt); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px 16px 86px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 14px; margin-bottom: 12px; }
    .title { font-size: 22px; margin: 0 0 4px; }
    .sub { color: var(--muted); margin: 0 0 10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; }
    .badge { border: 1px solid var(--line); border-radius: 999px; padding: 6px 10px; font-size: 12px; color: var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .input, .textarea, select { width:100%; background:#0d1b31; color:var(--txt); border:1px solid var(--line); border-radius:10px; padding:10px; }
    .textarea { min-height:80px; resize:vertical; }
    .btn { background:#22395f; border:1px solid var(--line); color:var(--txt); border-radius:10px; padding:10px 12px; cursor:pointer; }
    .btn.primary { background:var(--brand); border-color:var(--brand); }
    .btn.warn { background:var(--warn); border-color:var(--warn); color:#271a03; }
    .btn.ok { background:var(--ok); border-color:var(--ok); color:#062415; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px solid var(--line); border-radius:10px; padding:8px; }
    .muted { color:var(--muted); font-size:13px; }
    .err { color: var(--danger); font-weight: 600; }
    .hidden { display:none; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .chip { border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:12px; cursor:pointer; color:var(--muted); }
    .chip.active { border-color:#4ea3ff; color:#cde3ff; background:rgba(78,163,255,.18); }
    .section-title { margin: 0 0 6px; font-size: 17px; }
    .progress { height:10px; background:#0c1930; border:1px solid var(--line); border-radius:999px; overflow:hidden; }
    .progress > div { height:100%; background:linear-gradient(90deg, #3ba5ff, #42da94); width:0%; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--line); padding:6px; text-align:left; font-size:12px; }
    .module-tag { display:inline-block; padding:5px 10px; border-radius:999px; font-size:12px; font-weight:700; color:#fff; }
    .module-habits { background: var(--habits); }
    .module-sports { background: var(--sports); }
    .module-reading { background: var(--reading); color: #1f1500; }
    .module-challenge { background: var(--challenge); }
    .tab { display:none; }
    .tab.active { display:block; }
    .tabbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(8, 20, 38, 0.95);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(6px);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      padding: 8px;
      z-index: 20;
    }
    .tabbtn {
      border: 1px solid var(--line);
      background: #0f1d33;
      color: var(--muted);
      border-radius: 10px;
      padding: 10px 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .tabbtn.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    @media (max-width: 760px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 class="title">üî• Intizomli Erkak</h1>
    <p class="sub">Ro'yxatdan o'tish ‚Üí Modul sozlash ‚Üí To'lov ‚Üí 25 kunlik marafon</p>
    <div id="stateBadges" class="row"></div>
    <p id="statusMsg" class="muted"></p>
    <p id="stepMsg" class="muted"></p>
    <p id="errorMsg" class="err"></p>
  </div>

  <div id="regCard" class="card hidden">
    <h3 class="section-title">1) Ro'yxatdan o'tish</h3>
    <p class="muted">Barcha maydonlar majburiy.</p>
    <div class="grid">
      <input class="input" id="fullName" placeholder="Ism familiya" />
      <input class="input" id="age" placeholder="Yosh (9..80)" />
      <input class="input" id="location" placeholder="Qayerdanligi" />
      <textarea class="textarea" id="goal" placeholder="Marafonga qatnashish maqsadi"></textarea>
      <textarea class="textarea" id="pains" placeholder="Og'riqlar va muammolar"></textarea>
      <textarea class="textarea" id="expectations" placeholder="Marafondan kutilmalar"></textarea>
    </div>
    <div style="margin-top:10px"><button class="btn primary" id="saveReg">Saqlash</button></div>
  </div>

  <div id="setupCard" class="card hidden">
    <h3 class="section-title">2) Modullarni sozlash</h3>

    <div class="item">
      <h4>2.1 Odatlar</h4>
      <p class="muted">Xohlagancha odat qo'shing. Har odat uchun kunlarni belgilang.</p>
      <div class="row">
        <select id="habitTemplate" class="input"></select>
        <button class="btn" id="addHabitTemplate">Shablondan qo'shish</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="habitCustomName" class="input" placeholder="Yangi odat nomi" />
        <button class="btn" id="addHabitCustom">Odat qo'shish</button>
      </div>
      <div id="habitList" class="list" style="margin-top:8px"></div>
    </div>

    <div class="item" style="margin-top:10px">
      <h4>2.2 Sport</h4>
      <p class="muted">Xohlagancha sport turi qo'shing. Kunlar va miqdor kiriting.</p>
      <div class="row">
        <select id="sportTemplate" class="input"></select>
        <button class="btn" id="addSportTemplate">Shablondan qo'shish</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="sportCustomName" class="input" placeholder="Yangi sport nomi" />
        <button class="btn" id="addSportCustom">Sport qo'shish</button>
      </div>
      <div id="sportList" class="list" style="margin-top:8px"></div>
    </div>

    <div class="item" style="margin-top:10px">
      <h4>2.3 Mutolaa</h4>
      <p class="muted">Default kitob: Intizom kuchi. Istasangiz o'zgartiring.</p>
      <div class="grid">
        <input id="readingBook" class="input" placeholder="Kitob nomi" />
        <input id="readingPages" class="input" placeholder="Kunlik sahifa (masalan 30)" />
      </div>
    </div>

    <div class="item" style="margin-top:10px">
      <h4>Eslatma soatlari</h4>
      <p class="muted">Kuniga 3 mahal kiriting (masalan: 9,14,21).</p>
      <input id="remindersInput" class="input" placeholder="9,14,21" />
    </div>

    <div style="margin-top:10px">
      <button class="btn primary" id="saveSetup">Sozlamalarni saqlash</button>
    </div>
  </div>

  <div id="paymentCard" class="card hidden">
    <h3 class="section-title">3) To'lov</h3>
    <p class="muted">To'lov: <b>89 000 so'm</b>. Adminga to'lov qiling, maxsus kodni kiriting.</p>
    <div class="row">
      <button class="btn warn" id="requestPayment">Adminga o'tish</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input class="input" id="activationCode" placeholder="Maxsus kod" />
      <button class="btn primary" id="verifyCode">Kodni tasdiqlash</button>
    </div>
    <p id="paymentMsg" class="muted"></p>
  </div>

  <div id="tabReport" class="tab active">
    <div id="dailyCard" class="card">
      <h3 class="section-title">üìÖ Bugungi hisobot</h3>
      <p id="dayText" class="muted"></p>
      <div id="dailyPlan" class="list"></div>
      <div style="margin-top:10px"><button class="btn ok" id="sendDaily">Hisobot yuborish</button></div>
      <p id="dailyMsg" class="muted"></p>
    </div>
  </div>

  <div id="tabProgress" class="tab">
    <div id="progressCard" class="card">
      <h3 class="section-title">üìä Progress</h3>
      <p id="todayRemaining" class="muted"></p>
      <div id="moduleProgress" class="list"></div>
      <div id="chainBoard" class="chips" style="margin-top:10px"></div>
      <table style="margin-top:8px">
        <thead><tr><th>Sana</th><th>Modul</th><th>Bajarildi</th><th>Foiz</th></tr></thead>
        <tbody id="progressTable"></tbody>
      </table>
    </div>
    <div id="leaderboardCard" class="card">
      <h3 class="section-title">üèÜ Leaderboard</h3>
      <div id="leaderboardBody" class="list"></div>
    </div>
  </div>

  <div id="tabProfile" class="tab">
    <div id="profileCard" class="card">
      <h3 class="section-title">üë§ Profil</h3>
      <div id="profileBody" class="list"></div>
    </div>
    <div id="certificateCard" class="card hidden">
      <h3 class="section-title">üéì Sertifikat</h3>
      <p id="certificateText" class="muted"></p>
    </div>
  </div>
</div>

<div class="tabbar" id="tabbar">
  <button class="tabbtn active" data-tab="report">üìù Hisobot</button>
  <button class="tabbtn" data-tab="progress">üìä Progress</button>
  <button class="tabbtn" data-tab="profile">üë§ Profil</button>
</div>

<script>
const tg = window.Telegram?.WebApp;
const API = new URLSearchParams(window.location.search).get("api") || "https://intizomli-api-production.up.railway.app";
const tgUser = tg?.initDataUnsafe?.user;
const TG_ID = tgUser?.id;
const DEVICE_ID_KEY = `intizomli_device_${TG_ID || 'anon'}`;
let DEVICE_ID = localStorage.getItem(DEVICE_ID_KEY);
if (!DEVICE_ID) {
  DEVICE_ID = `${Date.now()}_${Math.random().toString(36).slice(2, 12)}`;
  localStorage.setItem(DEVICE_ID_KEY, DEVICE_ID);
}

let STATE = null;
let TEMPLATES = null;
let PAYMENT_META = null;

let habitPlans = [];
let sportPlans = [];
let weekdays = [
  {key:'mon',label:'Du'}, {key:'tue',label:'Se'}, {key:'wed',label:'Cho'},
  {key:'thu',label:'Pa'}, {key:'fri',label:'Ju'}, {key:'sat',label:'Sha'}, {key:'sun',label:'Ya'}
];

if (tg) { tg.ready(); tg.expand(); }

const qs = (id) => document.getElementById(id);
const draftKey = () => `intizomli_draft_${TG_ID || 'anon'}`;

async function api(path, options = {}) {
  const res = await fetch(API + path, { headers: {"Content-Type":"application/json"}, ...options });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || `HTTP ${res.status}`);
  }
  return res.json();
}

function red(msg){ qs('errorMsg').textContent = msg || ''; }
function setStatus(msg){ qs('statusMsg').textContent = msg || ''; }
function setStep(msg){ qs('stepMsg').textContent = msg || ''; }

function setTab(tab){
  qs('tabReport').classList.toggle('active', tab === 'report');
  qs('tabProgress').classList.toggle('active', tab === 'progress');
  qs('tabProfile').classList.toggle('active', tab === 'profile');
  [...document.querySelectorAll('.tabbtn')].forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
}

function loadDraft(){
  try {
    const raw = localStorage.getItem(draftKey());
    return raw ? JSON.parse(raw) : {};
  } catch (e) { return {}; }
}
function saveDraft(patch){
  const curr = loadDraft();
  const next = {...curr, ...patch};
  localStorage.setItem(draftKey(), JSON.stringify(next));
}
function clearDraft(){ localStorage.removeItem(draftKey()); }

function parseCsvHours(v){
  const parts = String(v || '').split(',').map(x => Number(x.trim())).filter(x => Number.isInteger(x) && x >= 0 && x <= 23);
  return [...new Set(parts)].slice(0, 3);
}

function fieldValidationError(){
  const fullName = qs('fullName').value.trim();
  const ageRaw = qs('age').value.trim();
  const location = qs('location').value.trim();
  const goal = qs('goal').value.trim();
  const pains = qs('pains').value.trim();
  const expectations = qs('expectations').value.trim();

  if (!fullName || fullName.length < 3) return "Iltimos, 'Ism familiya' bo'limini to'g'ri to'ldiring.";
  if (!ageRaw || !/^\d+$/.test(ageRaw)) return "Iltimos, 'Yosh' bo'limini raqamda to'g'ri kiriting.";
  const age = Number(ageRaw);
  if (age < 9 || age > 80) return "Iltimos, 'Yosh' bo'limini to'g'ri to'ldiring (9..80).";
  if (!location || location.length < 2) return "Iltimos, 'Qayerdanligi' bo'limini to'g'ri to'ldiring.";
  if (!goal || goal.length < 5) return "Iltimos, 'Maqsad' bo'limini to'g'ri to'ldiring.";
  if (!pains || pains.length < 5) return "Iltimos, 'Og'riqlar va muammolar' bo'limini to'g'ri to'ldiring.";
  if (!expectations || expectations.length < 5) return "Iltimos, 'Kutilmalar' bo'limini to'g'ri to'ldiring.";
  return null;
}

function renderState(){
  const badges = [
    `ID: ${TG_ID || '-'}`,
    `To'lov: ${STATE.payment_status}`,
    `Start: ${STATE.marathon_start_date || '-'}`,
    `Kun: ${STATE.marathon_day}/${STATE.marathon_days}`,
    `Reyting: ${STATE.rating_points || 0}`,
  ];
  qs('stateBadges').innerHTML = badges.map(x => `<div class="badge">${x}</div>`).join('');

  const setupDone = STATE.setup_completed;
  const regDone = STATE.registration_completed;
  const paidDone = STATE.payment_status === 'paid';

  qs('regCard').classList.toggle('hidden', regDone);
  qs('setupCard').classList.toggle('hidden', !(regDone && !setupDone));
  qs('paymentCard').classList.toggle('hidden', !(regDone && setupDone && !paidDone));

  const reportOpen = !!STATE.is_active;
  qs('sendDaily').disabled = !reportOpen;

  if (!regDone) {
    setStatus("Ro'yxatdan o'tishni yakunlang.");
    setStep("Bosqich: 1/3 ‚Äî Ro'yxatdan o'tish");
  } else if (!setupDone) {
    setStatus("Modullarni sozlashni yakunlang.");
    setStep("Bosqich: 2/3 ‚Äî Modullarni sozlash");
  } else if (!paidDone) {
    setStatus("To'lov tasdiqlanishini kuting.");
    setStep("Bosqich: 3/3 ‚Äî To'lov va kod");
  } else if (!reportOpen) {
    setStatus(`Marafon hali boshlanmagan. Hisobot va progress ${STATE.marathon_start_date} dan boshlanadi.`);
    setStep("To'lov tasdiqlandi. Start sanasi kutilmoqda.");
  } else {
    setStatus("Marafon aktiv. Hisobot faqat bugungi kun uchun yuboriladi.");
    setStep("Marafon davom etmoqda.");
  }

  qs('certificateCard').classList.toggle('hidden', !STATE.certificate_issued);
  if (STATE.certificate_issued) {
    qs('certificateText').textContent = `Sertifikat tayyor. Kod: ${STATE.certificate_code}`;
  }
}

function renderProfile(){
  const rows = [
    [`Ism`, STATE.full_name || '-'],
    [`Yosh`, STATE.age ?? '-'],
    [`Hudud`, STATE.location || '-'],
    [`Maqsad`, STATE.goal || '-'],
    [`Og'riqlar`, STATE.pains || '-'],
    [`Kutilmalar`, STATE.expectations || '-'],
  ];
  qs('profileBody').innerHTML = rows.map(r => `<div class="item"><b>${r[0]}:</b><div class="muted">${r[1]}</div></div>`).join('');
}

function dayChips(selectedDays = ['daily']){
  const chips = [`<span class="chip ${selectedDays.includes('daily') ? 'active': ''}" data-day="daily">Har kuni</span>`];
  weekdays.forEach(d => chips.push(`<span class="chip ${selectedDays.includes(d.key) ? 'active': ''}" data-day="${d.key}">${d.label}</span>`));
  return `<div class="chips">${chips.join('')}</div>`;
}

function renderHabitList(){
  qs('habitList').innerHTML = habitPlans.map((h, i) => `
    <div class="item" data-kind="habit" data-idx="${i}">
      <div class="row" style="justify-content:space-between"><b>${h.name}</b><button class="btn" data-action="remove-habit" data-idx="${i}">O'chirish</button></div>
      ${dayChips(h.days)}
    </div>`).join('') || `<p class="muted">Hali odat qo'shilmagan.</p>`;
}

function renderSportList(){
  qs('sportList').innerHTML = sportPlans.map((s, i) => `
    <div class="item" data-kind="sport" data-idx="${i}">
      <div class="row" style="justify-content:space-between"><b>${s.name}</b><button class="btn" data-action="remove-sport" data-idx="${i}">O'chirish</button></div>
      ${dayChips(s.days)}
      <div style="margin-top:8px"><input class="input" data-action="sport-target" data-idx="${i}" value="${s.target_count || ''}" placeholder="Miqdor (masalan 100)" /></div>
    </div>`).join('') || `<p class="muted">Hali sport qo'shilmagan.</p>`;
}

function fillTemplates(){
  if (!TEMPLATES) return;
  weekdays = TEMPLATES.weekdays || weekdays;

  const hSel = qs('habitTemplate');
  hSel.innerHTML = (TEMPLATES.habits || []).map(x => `<option>${x}</option>`).join('');
  const sSel = qs('sportTemplate');
  sSel.innerHTML = (TEMPLATES.sports || []).map(x => `<option>${x}</option>`).join('');

  if (!habitPlans.length && Array.isArray(STATE.habits) && STATE.habits.length) habitPlans = STATE.habits;
  if (!sportPlans.length && Array.isArray(STATE.sports) && STATE.sports.length) sportPlans = STATE.sports;

  qs('readingBook').value = STATE?.reading_book || TEMPLATES.default_book || 'Intizom kuchi';
  qs('readingPages').value = STATE?.reading_pages_per_day || 30;
  qs('remindersInput').value = (STATE?.reminder_hours || [9,14,21]).join(',');

  renderHabitList();
  renderSportList();
}

function setupValidationError(){
  if (habitPlans.length < 1) return "Kamida 1 ta odat kiriting.";
  if (sportPlans.length < 1) return "Kamida 1 ta sport kiriting.";
  const readingBook = qs('readingBook').value.trim();
  const pages = Number(qs('readingPages').value.trim());
  if (!readingBook) return "Mutolaa bo'limida kitob nomini kiriting.";
  if (!Number.isInteger(pages) || pages < 1 || pages > 300) return "Mutolaa sahifasi 1 dan 300 gacha bo'lishi kerak.";
  const hrs = parseCsvHours(qs('remindersInput').value);
  if (hrs.length !== 3) return "Eslatma soatlarini 3 ta kiriting (masalan 9,14,21).";
  return null;
}

function toggleDays(target, plans){
  const idx = Number(target.closest('[data-idx]').dataset.idx);
  const day = target.dataset.day;
  const item = plans[idx];
  if (!item) return;
  if (day === 'daily') item.days = ['daily'];
  else {
    item.days = (item.days || []).filter(d => d !== 'daily');
    if (item.days.includes(day)) item.days = item.days.filter(d => d !== day);
    else item.days.push(day);
    if (!item.days.length) item.days = ['daily'];
  }
}

function moduleClass(module){
  if (module === 'habits') return 'module-habits';
  if (module === 'sports') return 'module-sports';
  if (module === 'reading') return 'module-reading';
  return 'module-challenge';
}

function moduleTitle(module){
  if (module === 'habits') return 'Odatlar';
  if (module === 'sports') return 'Sport';
  if (module === 'reading') return 'Mutolaa';
  if (module === 'challenge') return 'Mashaqqat';
  return module;
}

async function loadDaily(){
  try {
    const d = await api(`/v1/app/daily/${TG_ID}`);
    qs('dayText').textContent = `${d.report_date} | ${d.day}-kun`;

    const blocks = [];
    Object.entries(d.plan || {}).forEach(([module, items]) => {
      if (!items.length) return;
      blocks.push(`<div class="item"><span class="module-tag ${moduleClass(module)}">${moduleTitle(module)}</span></div>`);
      items.forEach(item => {
        const key = `${module}:${item}`;
        const checked = d.checked?.[key] ? 'checked' : '';
        blocks.push(`<label class="item"><input type="checkbox" data-module="${module}" data-item="${item}" ${checked}/> ${item}</label>`);
      });
    });
    qs('dailyPlan').innerHTML = blocks.join('') || `<p class='muted'>Bugun vazifa yo'q.</p>`;
  } catch (e) {
    qs('dayText').textContent = '';
    qs('dailyPlan').innerHTML = `<p class='muted'>${(e.message || '').replace(/^\{"detail":"|"\}$/g, '') || 'Hisobot hali ochilmagan'}</p>`;
  }
}

async function loadProgress(){
  const p = await api(`/v1/app/progress/${TG_ID}`);
  const mp = p.module_percent || {};
  qs('todayRemaining').textContent = `Bugungi qoldiq: ${p.today_remaining || 0}%`;
  qs('moduleProgress').innerHTML = Object.keys(mp).map(m => `
    <div>
      <div class="row" style="justify-content:space-between"><span>${moduleTitle(m)}</span><span>${mp[m]}%</span></div>
      <div class="progress"><div style="width:${mp[m]}%"></div></div>
    </div>`).join('') || `<p class='muted'>Hali progress yo'q.</p>`;
  qs('progressTable').innerHTML = (p.table || []).map(r => `<tr><td>${r.date}</td><td>${moduleTitle(r.module)}</td><td>${r.done}/${r.total}</td><td>${r.percent}%</td></tr>`).join('');

  const chain = p.chain || [];
  qs('chainBoard').innerHTML = chain.map((c) => {
    const cls = c.status === 'empty' ? '' : 'active';
    const icon = c.status === 'done' ? '‚úÖ' : (c.status === 'partial' ? 'üü®' : '‚¨ú');
    return `<span class="chip ${cls}">${icon} ${c.day}</span>`;
  }).join('');
}

async function loadLeaderboard(){
  const lb = await api('/v1/app/leaderboard?limit=10');
  const items = lb.items || [];
  qs('leaderboardBody').innerHTML = items.map((x) => `
    <div class="item"><b>${x.rank}. ${x.name}</b><div class="muted">${x.rating_points} ball | streak ${x.streak} | ${x.level?.name || '-'}</div></div>
  `).join('') || `<p class='muted'>Hali leaderboard bo'sh.</p>`;
}

async function bootstrap(){
  if (!TG_ID) {
    setStatus(`Telegram ichida oching. API: ${API}`);
    return;
  }
  const b = await api('/v1/app/bootstrap', {
    method: 'POST',
    body: JSON.stringify({
      tg_user_id: TG_ID,
      username: tgUser?.username || null,
      first_name: tgUser?.first_name || null,
      device_id: DEVICE_ID,
    }),
  });
  TEMPLATES = b.templates;
  PAYMENT_META = b.payment || {};

  STATE = await api(`/v1/app/state/${TG_ID}`);
  if (Array.isArray(STATE.habits) && STATE.habits.length) habitPlans = STATE.habits;
  if (Array.isArray(STATE.sports) && STATE.sports.length) sportPlans = STATE.sports;

  renderState();
  renderProfile();
  fillTemplates();

  const draft = loadDraft();
  if (!STATE.registration_completed && Object.keys(draft).length) {
    if (draft.fullName) qs('fullName').value = draft.fullName;
    if (draft.age) qs('age').value = draft.age;
    if (draft.location) qs('location').value = draft.location;
    if (draft.goal) qs('goal').value = draft.goal;
    if (draft.pains) qs('pains').value = draft.pains;
    if (draft.expectations) qs('expectations').value = draft.expectations;
  }

  await loadDaily();
  await loadProgress();
  await loadLeaderboard();
}

qs('saveReg').addEventListener('click', async () => {
  red('');
  const err = fieldValidationError();
  if (err) { red(err); return; }
  try {
    await api('/v1/app/register', {
      method: 'POST',
      body: JSON.stringify({
        tg_user_id: TG_ID,
        full_name: qs('fullName').value.trim(),
        age: Number(qs('age').value.trim()),
        location: qs('location').value.trim(),
        goal: qs('goal').value.trim(),
        pains: qs('pains').value.trim(),
        expectations: qs('expectations').value.trim(),
      }),
    });
    clearDraft();
    await bootstrap();
  } catch (e) {
    red((e.message || '').replace(/^\{"detail":"|"\}$/g, '') || "Ro'yxatdan o'tishda xato");
  }
});

qs('addHabitTemplate').addEventListener('click', () => {
  const name = qs('habitTemplate').value.trim();
  if (!name) return;
  if (!habitPlans.find(x => x.name.toLowerCase() === name.toLowerCase())) habitPlans.push({name, days: ['daily']});
  renderHabitList();
});
qs('addHabitCustom').addEventListener('click', () => {
  const name = qs('habitCustomName').value.trim();
  if (!name) return;
  if (!habitPlans.find(x => x.name.toLowerCase() === name.toLowerCase())) habitPlans.push({name, days: ['daily']});
  qs('habitCustomName').value = '';
  renderHabitList();
});
qs('addSportTemplate').addEventListener('click', () => {
  const name = qs('sportTemplate').value.trim();
  if (!name) return;
  if (!sportPlans.find(x => x.name.toLowerCase() === name.toLowerCase())) sportPlans.push({name, days: ['daily'], target_count: null});
  renderSportList();
});
qs('addSportCustom').addEventListener('click', () => {
  const name = qs('sportCustomName').value.trim();
  if (!name) return;
  if (!sportPlans.find(x => x.name.toLowerCase() === name.toLowerCase())) sportPlans.push({name, days: ['daily'], target_count: null});
  qs('sportCustomName').value = '';
  renderSportList();
});

qs('setupCard').addEventListener('click', (e) => {
  const t = e.target;
  if (t.dataset.action === 'remove-habit') { habitPlans.splice(Number(t.dataset.idx), 1); renderHabitList(); return; }
  if (t.dataset.action === 'remove-sport') { sportPlans.splice(Number(t.dataset.idx), 1); renderSportList(); return; }
  if (t.classList.contains('chip') && t.closest('[data-kind="habit"]')) { toggleDays(t, habitPlans); renderHabitList(); return; }
  if (t.classList.contains('chip') && t.closest('[data-kind="sport"]')) { toggleDays(t, sportPlans); renderSportList(); return; }
});

qs('setupCard').addEventListener('input', (e) => {
  const t = e.target;
  if (t.dataset.action === 'sport-target') {
    const idx = Number(t.dataset.idx);
    const v = Number(t.value);
    sportPlans[idx].target_count = Number.isInteger(v) && v > 0 ? v : null;
  }
});

qs('saveSetup').addEventListener('click', async () => {
  red('');
  const err = setupValidationError();
  if (err) { red(err); return; }

  try {
    await api('/v1/app/setup', {
      method: 'POST',
      body: JSON.stringify({
        tg_user_id: TG_ID,
        modules: ['habits', 'sports', 'reading'],
        setup: {
          habits: habitPlans,
          sports: sportPlans,
          reading: { book: qs('readingBook').value.trim(), pages_per_day: Number(qs('readingPages').value.trim()) },
        },
        reminder_hours: parseCsvHours(qs('remindersInput').value),
      }),
    });
    clearDraft();
    await bootstrap();
  } catch (e) {
    red((e.message || '').replace(/^\{"detail":"|"\}$/g, '') || "Modul sozlashda xato");
  }
});

qs('requestPayment').addEventListener('click', async () => {
  red('');
  try {
    const r = await api('/v1/app/payment/request', { method: 'POST', body: JSON.stringify({tg_user_id: TG_ID}) });
    qs('paymentMsg').textContent = r.note || "To'lov kutilmoqda.";
    const adminUrl = r.admin_url || PAYMENT_META?.admin_url;
    const deep = r.admin_tg_deep_link;
    if (adminUrl) {
      if (tg?.openTelegramLink) tg.openTelegramLink(adminUrl);
      else if (tg?.openLink) tg.openLink(adminUrl);
      else window.open(adminUrl, '_blank');
    } else if (deep) {
      if (tg?.openLink) tg.openLink(deep);
      else window.location.href = deep;
    }
    await bootstrap();
  } catch (e) {
    red((e.message || '').replace(/^\{"detail":"|"\}$/g, '') || "To'lov bo'limida xato");
  }
});

qs('verifyCode').addEventListener('click', async () => {
  red('');
  try {
    const code = qs('activationCode').value.trim();
    if (!code) { red("Avval maxsus kodni kiriting."); return; }
    const r = await api('/v1/app/payment/verify-code', {
      method: 'POST',
      body: JSON.stringify({tg_user_id: TG_ID, code, device_id: DEVICE_ID}),
    });
    qs('paymentMsg').textContent = r.marathon_started ? "‚úÖ To'lov tasdiqlandi." : "Kod tasdiqlandi.";
    await bootstrap();
  } catch (e) {
    red((e.message || '').replace(/^\{"detail":"|"\}$/g, '') || "Kod tekshirishda xato");
  }
});

qs('sendDaily').addEventListener('click', async () => {
  red('');
  const checked = {};
  [...qs('dailyPlan').querySelectorAll("input[type='checkbox']")].forEach(ch => {
    if (!ch.checked) return;
    const m = ch.dataset.module;
    if (!checked[m]) checked[m] = [];
    checked[m].push(ch.dataset.item);
  });

  try {
    const r = await api('/v1/app/daily/report', { method: 'POST', body: JSON.stringify({tg_user_id: TG_ID, checked}) });
    qs('dailyMsg').textContent = `Hisobot saqlandi: ${r.percent}%`;
    if (tg) tg.sendData(JSON.stringify({type:'daily_report_submitted', percent:r.percent}));
    await loadProgress();
  } catch (e) {
    red((e.message || '').replace(/^\{"detail":"|"\}$/g, '') || "Hisobot yuborishda xato");
  }
});

qs('tabbar').addEventListener('click', (e) => {
  const b = e.target.closest('.tabbtn');
  if (!b) return;
  setTab(b.dataset.tab);
});

window.addEventListener('error', (event) => red(`Frontend xatosi: ${event.message || 'Noma\'lum'}`));
['fullName','age','location','goal','pains','expectations'].forEach((id) => {
  qs(id).addEventListener('input', () => {
    saveDraft({
      fullName: qs('fullName').value,
      age: qs('age').value,
      location: qs('location').value,
      goal: qs('goal').value,
      pains: qs('pains').value,
      expectations: qs('expectations').value,
    });
  });
});

setTab('report');
bootstrap().catch((e) => red(`Yuklashda xato: ${e.message || 'Load failed'}`));
</script>
</body>
</html>
